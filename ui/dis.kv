<MainWindow>:
    id: main_window

    RelativeLayout:
        size_hint: 1, 1
        
        id: main_panel
        RelativeLayout:
            size_hint: 1, None
            pos: 0, main_panel.height - self.height - app_menu.height
            height: self.parent.height - app_menu.height

            Dock:
                id: main_dock

        FloatLayout:
            pos: 0, main_panel.height - app_menu.height
            size_hint: 1, None
            height: app_menu.height

            AppMenu:
                top: root.height
                id: app_menu
                cancel_handler_widget: main_window

            BoxLayout:
                id: navigation_menu
                pos_hint: { "right": 1, "top": 1 }
                size_hint: None, 1
                width: dp(70)
                
                IconButton:
                    id: back_button
                    source: "ui/resources/left_arrow.png"
                    disabled: True
                    icon_height: dp(20)
                IconButton:
                    id: forward_button
                    source: "ui/resources/right_arrow.png"
                    disabled: True
                    icon_height: dp(20)

    GotoPosition:
        id: goto_position
        multiline: False
        opacity: 0
        disabled: True
        size_hint: None, None
        width: dp(240)
        height: self.minimum_height
        pos_hint: { "center_x": 0.5, "top": 1 }

    RenameInput:
        id: rename_input
        width: dp(180)
        height: dp(30)

<RenameInput>:
    size_hint: None, None
    opacity: 0
    disabled: True

    canvas.before:
        Color:
            rgba: 0.18, 0.18, 0.18, 1.0
        RoundedRectangle:
            pos: self.x - dp(5), self.y - dp(5)
            size: self.width + dp(10), self.height + dp(10)
            radius: [dp(5)]

    TextInput:
        multiline: False
        id: input
        opacity: root.opacity
        disabled: root.disabled
        size_hint: 1, None
        height: self.minimum_height

<ScrollBar>:
    size_hint: 1, None
    do_scroll_x: True
    do_scroll_y: False
    height: dp(15)

    ScrollView:
        id: scroll_view
        bar_width: dp(15)
        scroll_type: ["bars"]
        on_scroll_move: root.on_scroll_move()
        effect_cls: "ScrollEffect"

        BoxLayout:
            size_hint: None, None
            width: root.base_width
            height: dp(15)

<ListingPanel>:
    size_hint: 1, 1
    toggled: False

    Minimap:
        id: minimap
    RV:
        id: rv
    ArrowRenderer:  
        id: arrows
    ScrollBar:
        id: scrollbar
        pos_hint: { "left": 1, "bottom": 1 }

    IconButton:
        id: toggle_menu
        size_hint: None, None
        source: "ui/resources/expand.png" if root.toggled else "ui/resources/contract.png"
        opacity: 0 if root.is_root else 1
        disabled: root.is_root
        size: dp(20), dp(20)
        icon_height: dp(15)
        pos_hint: {"left": 1, "top": 1}
        on_press: root.toggle()

<AnalyzerLabel>:
    size_hint: None, 1
    width: self.parent.column_widths[0] + dp(5) if self.parent else dp(100)

<AnalyzerButtons>:
    size_hint: None, 1
    width: self.parent.column_widths[self.column] + dp(5) if self.parent else dp(100)

    IconButton:
        source: "ui/resources/goto.png"
        size_hint: None, None
        size: dp(20), dp(20)
        pos_hint: {"left": 1, "center_y": 0.5}
        on_press: self.parent.on_press("goto")
    IconButton:
        source: "ui/resources/code-listing.png"
        size_hint: None, None
        size: dp(20), dp(20)
        x: dp(25)
        pos_hint: {"left": 1, "center_y": 0.5}
        on_press: self.parent.on_press("listing")
    IconButton:
        source: "ui/resources/graph.png"
        size_hint: None, None
        size: dp(20), dp(20)
        x: dp(50)
        pos_hint: {"left": 1, "center_y": 0.5}
        on_press: self.parent.on_press("graph")
    IconButton:
        source: "ui/resources/calls.png"
        size_hint: None, None
        size: dp(20), dp(20)
        x: dp(75)
        pos_hint: {"left": 1, "center_y": 0.5}
        on_press: self.parent.on_press("calls")

<AnalyzerPanel>:
    ScrollView:
        id: scroll_view
        size_hint: 1, 1
        scroll_type: ["bars"]
        bar_width: dp(15)
        do_scroll_x: True

        AnalyzerTable:
            padding: 0, 0, 0, dp(15) # the scroll view eats touch events so the horizontal scrollbar needs a bit of space
            size_hint: None, 1
            width: max(self.parent.width, self.minimum_width)
            id: analyzer_table
    BoxLayout:
        padding: 0, dp(30), dp(30), 0
        size_hint: None, None
        width: dp(180)
        height: analyzer_filter.height + dp(30)
        pos_hint: { "right": 1, "top": 1 }

        BoxLayout:
            opacity: analyzer_filter.opacity
            size_hint: 1, 1
            canvas.before:
                Color:
                    rgba: 0.18, 0.18, 0.18, 1.0
                RoundedRectangle:
                    pos: self.x - dp(5), self.y - dp(5)
                    size: self.width + dp(10), self.height + dp(10)
                    radius: [dp(5)]

            AnalyzerFilter:
                multiline: False
                id: analyzer_filter
                opacity: 0
                disabled: True
                hint_text: "Filter Functions"
                size_hint: 1, None
                height: self.minimum_height

<ArrowRenderer>:
    size_hint: None, 1
    width: dp(15) * 12
    pos_hint: { "left": 1, "top": 1 }

<Minimap>:
    size_hint: None, 1
    width: dp(15)
    pos_hint: { "right": 1, "top": 1 }

<RV>:
    size_hint: 1, 1
    bar_width: dp(15)
    scroll_wheel_distance: 50
    scroll_type: ['bars']
    viewclass: 'SectionPanel'

    RecycleBoxLayout:
        size_hint: 1, None
        height: self.minimum_height
        orientation: 'vertical'

<SectionPanel>:
    orientation: 'vertical'
    width: self.parent.width - dp(15) if self.parent else 0
    
    LabelRow:
        rv: root.rv
        id: label
        # TODO using padding here makes the layout slower, 
        # this should really be x but its not working properly somehow
        padding: dp(250) + root.xoffset, 0, 0, 0

    RelativeLayout:
        size_hint: 1, 1
        SectionData:
            rv: root.rv
            halign: "left"
            pos: dp(270) + root.xoffset, 0
            text_size: self.width, self.height
            height: self.parent.height
            id: data
        SectionAddresses:
            rv: root.rv
            width: dp(240)
            pos: root.xoffset, 0
            halign: "right"
            text_size: self.width, self.height
            height: self.parent.height
            id: addresses
        SectionMnemonic:
            rv: root.rv
            pos: dp(550) + root.xoffset, 0
            size_hint: None, 1
            halign: "left"
            markup: True

            text_size: self.width, self.height
            height: self.parent.height
            id: mnemonics

<InvalidInsnPopup>:
    auto_dismiss: False
    title: "Invalid instruction"
    size_hint: None, None
    width: dp(300)
    height: dp(200)

    BoxLayout:
        orientation: 'vertical'
        Label:
            text: f"Hit an invalid instruction at {root.instruction:X}.\nYou can discard the active disassembly or keep the changes."
            text_size: self.width, None
            size_hint_y: 1
            height: self.texture_size[1]
            halign: 'center'
            valign: 'top'

        BoxLayout:
            size_hint: 1, None
            height: dp(40)
            Button:
                text: "Discard"
                on_release: root.dispatch("on_close")
            Button:
                text: "Keep"
                on_release: root.dispatch("on_continue")

<FunctionAnalyzerPopup>:
    auto_dismiss: False
    title: "Analyzing functions..."
    size_hint: None, None
    width: dp(300)
    height: dp(150)

    BoxLayout:
        size_hint: 1, 1
        orientation: 'vertical'
        padding: dp(10)

        Label:
            text: "Analyzing... " + root.current

        ProgressBar:
            size_hint: 1, None
            height: dp(20)
            max: root.max
            value: root.value

<FunctionTabItem>:
    size_hint: None, 1
    halign: "left"
    padding: dp(5), dp(5), dp(22.5), dp(5)
    width: self.texture_size[0] + dp(15)

<MemoryView>:
    size_hint: 1, 1
    MemoryMinimap:
        id: minimap
    MemoryRV:
        id: rv
    ScrollBar:
        id: scrollbar
        pos_hint: { "left": 1, "bottom": 1 }

<MemoryRV>:
    viewclass: 'MemorySection'

<MemorySection>:
    orientation: 'vertical'
    width: self.parent.width - dp(15) if self.parent else 0
    
    RelativeLayout:
        id: header
        size_hint: 1, None
        height: dp(20) if self.display else 0
        display: True
        disabled: not self.display
        opacity: 1 if self.display else 0

        Label:
            id: type
            size_hint: None, 1
            width: self.texture_size[0]
            x: dp(240) + root.xoffset - self.width
            font_name: "ui/resources/RobotoMono"
            font_size: dp(15)
            color: 0.337, 0.612, 0.839, 1
        MemoryLabel:
            size_hint: None, 1
            rv: root.rv
            id: label
            x: dp(250) + root.xoffset

    RelativeLayout:
        size_hint: 1, 1
        MemorySectionData:
            rv: root.rv
            halign: "left"
            pos: dp(270) + root.xoffset, 0
            text_size: self.width, self.height
            height: self.parent.height
            id: data
        SectionAddresses:
            rv: root.rv
            width: dp(240)
            pos: root.xoffset, 0
            halign: "right"
            text_size: self.width, self.height
            height: self.parent.height
            id: addresses
        SectionMnemonic:
            rv: root.rv
            pos: dp(550) + root.xoffset, 0
            size_hint: None, 1
            halign: "left"
            markup: True

            text_size: self.width, self.height
            height: self.parent.height
            id: mnemonics
            
    MemorySnip:
        id: snip
        size_hint: 1, None
        disabled: False
        opacity: 1
        height: dp(20)
        xoffset: root.xoffset
